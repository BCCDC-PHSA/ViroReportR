#' summarise a data frame `d` by groups along a `variable`
#' @param d tibble data frame
#' @param ... group_by variables
#' @param variable string
#'
#'  @importFrom magrittr "%>%"
#'  @import dplyr
#'  @importFrom rlang .data
#'
create_quantiles <- function(d, ..., variable = NULL) {
  d %>%
    dplyr::group_by(...) %>%
    dplyr::summarise(
      p50 = stats::quantile(.data[[variable]], 0.5),
      p25 = stats::quantile(.data[[variable]], 0.25),
      p75 = stats::quantile(.data[[variable]], 0.75),
      p05 = stats::quantile(.data[[variable]], 0.05),
      p95 = stats::quantile(.data[[variable]], 0.95)
    )
}

#' Summarise incidence values into weekly aggregate
#' @param samples Daily samples generated from \code{extract_daily_samples_epiestim_fit}
#'
#' @importFrom magrittr "%>%"
#' @import dplyr
#'
extract_agg_samples_epiestim_fit <- function(samples){

  value <- week_date <- sim <- NULL
  samples <- samples %>%
    dplyr::mutate(week_date = lubridate::floor_date(date,unit ="weeks")) %>%
    dplyr::group_by(week_date, sim) %>%
    dplyr::rename(value = incidence) %>%
    suppressMessages(dplyr::summarize(value = sum(value)))

  return (samples)
}


#' Helper function to extract dataframe with 1 week and 2 week ahead forecasts for Violin plot
#'
#' @param tp element from list output generated by \code{forecast_time_period_epiestim}
#'
#' @importFrom magrittr "%>%"
#'
#' @return Dataframe of 1 week and 2 week forecasts at a single timepoint

pred_samples_with_quantile_helper <- function(tp) {

  value <- NULL
  cur_samples_with_quantile <- extract_weekly_quantile_epiestim(tp)
  cur_samples_with_quantile$pred_horizon <- c("1 week ahead", "2 week ahead")
  cur_samples_with_week_date <- extract_weekly_samples_epiestim(tp)

  cur_samples_with_quantile <-  cur_samples_with_quantile %>%
    dplyr::left_join(cur_samples_with_week_date, by = "week_date") %>%
    dplyr::rename(sim_draws = value)

  return(cur_samples_with_quantile)

}

#' extract model data with extension during each iteration of loop
#'
#' @param data *data frame* containing two columns: date and confirm (number of cases per day)
#' @param min_model_date_str start date (in str)
#' @param extension_interval an integer (# of days)
#'
#' @importFrom magrittr "%>%"
#' @import dplyr
#' @import lubridate
#'
#' @return model_data with # of days extension specified



extend_rows_model_data <- function(data, min_model_date_str,
                                              extension_interval=0){
  min_model_date <- lubridate::ymd(min_model_date_str)
  max_model_date <- data$date[which(data$date == min_model_date) + 1]

  if (extension_interval > 0){
    max_model_date <- max_model_date + extension_interval
  }
model_data <- data %>%
    filter(date >= min_model_date, date <= max_model_date)

  return(model_data)
}



#' Extract calculated quantiles from the weekly samples
#'
#' @param time_period_result output from \code{forecast_time_period_epiestim}
#'


extract_weekly_quantile_epiestim <- function(time_period_result){
  dat_quantiles <- tibble::tibble(week_date = time_period_result$quantile_week_date,
                p50 = time_period_result$p50,
                p25 = time_period_result$p25,
                p75 = time_period_result$p75,
                p05 = time_period_result$p05,
                p95 = time_period_result$p95)
  return(dat_quantiles)
}


# Extract weekly simulated samples

#' Extract Weekly Samples (week_date & value) ideally 1000 samples per date
#'
#' @param time_period_result output from \code{forecast_time_period_epiestim}


extract_weekly_samples_epiestim <- function(time_period_result){
  dat_weekly_samples <- tibble::tibble(week_date = time_period_result$week_date,
                value = time_period_result$value)
  return(dat_weekly_samples)
}


#' Helper function to plot forecasts at each iteration with uncertainity quantile ranges
#'
#' @param  cur_time_period_result element from list output generated by \code{forecast_time_period_epiestim}
#' @param xlab x-axis title
#' @param ylab y-axis title

plot_all_time_period_forecast_data_helper <- function(cur_time_period_result, xlab = "", ylab = ""){

    model_data <- tibble::tibble(date = cur_time_period_result$model_data_date,
                         confirm = cur_time_period_result$confirm)

    data_proj <- tibble::tibble(date = cur_time_period_result$daily_date,
                        sim = cur_time_period_result$daily_sim,
                        incidence = cur_time_period_result$daily_value)

    plot(data_proj %>%
           dplyr::mutate(incidence = 7*incidence) %>%
           create_quantiles(date,variable = "incidence") %>%
           ggplot2::ggplot(aes(x = date)) +
           theme_bw() +
           ggplot2::geom_ribbon(aes(ymin = p05, ymax = p95), fill = "#08519C", alpha = 0.25) +
           ggplot2::geom_ribbon(aes(ymin = p25, ymax = p75), fill = "#08519C", alpha = 0.25) +
           ggplot2::geom_line(aes(y = p50), color = "#08519C") +
           ggplot2::geom_point(aes(x = date, y = confirm), data = model_data) +
           labs(x = xlab, y = ylab, fill = "", color = ""))
  }


