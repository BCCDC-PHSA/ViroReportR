---
title: "Summary report of short-term forecasts for viral respiratory diseases by `ViroReportR`"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  filepath: NULL
  start_date: NULL
  n_days: 7
  smooth: TRUE
  validate_window_size: 7
---


```{r setup, include=FALSE, echo = FALSE,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# setup -------------------------------------------------------------------
library(dplyr)
library(ViroReportR)
library(ggplot2)
library(here)
library(DT)
library(purrr)
library(kableExtra)
```


```{r load data}
# Load data
vri_data <- utils::read.csv(file.path(params$filepath))

vri_data$date <- lubridate::ymd(vri_data$date)

# VRI data set-up
vri_name_list <- vri_data %>% 
    dplyr::group_by(disease_type) %>% 
  dplyr::group_keys() %>% pull()


vri_data_list <- vri_data %>% 
  dplyr::group_by(disease_type) %>% 
  dplyr::group_map(~.x)

names(vri_data_list) <- vri_name_list

# document parameters set-up
start_date <- params$start_date
if(is.null(start_date)){
  start_date <- min(vri_data$date) + 13
}

forecast_horizon <- params$n_days
smooth <- params$smooth
validate_window_size <- params$validate_window_size
```



```{r generate forecasts}
forecasts_results <- tibble(
  vri_data_list,
  forecasts = map2(
    vri_data_list,
    vri_name_list,
    ~ generate_forecast(
      data = .x,
      smooth_data = smooth,
      type = .y,
      n_days = forecast_horizon,
      start_date = start_date
    )
  )
)

names(forecasts_results$forecasts) <- vri_name_list
names(forecasts_results$vri_data_list) <- vri_name_list
```

## Description

This report provides the forecast of `r forecast_horizon`-days ahead confirmed cases for the 3 prevalent respiratory viral cases in BC (Flu-A, RSV and SARS-CoV-2). Forecast reports were generated using the Provincial Lab (PLIS) data. `vriforecasting` uses `EpiEstim` as the backend to forecast weekly confirmed cases, which forecasts cases by estimating the instantaneous reproduction number using the [Cori method](https://academic.oup.com/aje/article/178/9/1505/89262) and then simulating the number of new cases using fixed exponential growth over a given time period. This is a short term prediction model, meaning that an increase in the time-period horizon over an optimal horizon of 1 or 2-weeks ahead results in a decline of prediction performance. The report is divided into two sections: `r forecast_horizon`-days forecast for the current season of respiratory cases as well as validation plots and metrics for the performance of the forecasting model on historical data to help in the assessment of model performance. 

# `r forecast_horizon`-days ahead forecast {.tabset}

### Description {.tabset}

This section presents the `r forecast_horizon`-days ahead forecasts for each virus. The forecasts include:

- Median predicted cases (p50)
- Prediction intervals (50% and 95%)
- The last estimated Rₜ value with 95% confidence intervals

Plots show the predicted cases alongside historical observations, helping visualize the expected trajectory of cases over the short-term forecast horizon.

```{r forecast plots and info, results = "asis", out.width = '80%'}
for (vri in vri_name_list) {
  cat(glue::glue("#### {vri} "))
  cat("\n\n\n")
 print(
  ggplot(forecasts_results$forecasts[[vri]][["forecast_res_quantiles"]], aes(x = date)) +
  geom_ribbon(aes(ymin = p10, ymax = p90), fill = "skyblue", alpha = 0.4) +
  geom_line(aes(y = p50), color = "blue", size = 1) +
  geom_point(data = forecasts_results$vri_data_list[[vri]], aes( x = date, y = confirm), color = "black", size = 1) +
  labs(
    title = paste0(forecast_horizon, "-Day Forecast of Daily RSV Cases (Smoothed)"),
    x = "Date", y = "Predicted Cases"
  ) +
  theme_minimal())
  cat("\n\n\n")
 print(ViroReportR:::plot_rt(forecasts_results$forecasts[[vri]]))
  cat("\n\n\n")
  ViroReportR:::current_forecast_text(forecasts_results$forecasts[[vri]])
  cat("\n\n\n")
}
```


# `r forecast_horizon`-days ahead Model Forecast Validation

### Description {.tabset}

The forecasting model is trained on historical data and used to predict daily cases `r forecast_horizon`-days ahead. Validation compares the model's forecasted values with observed historical data. Overlap between the prediction intervals and actual cases indicates good model performance.

```{r forecast validation plots, results = "asis", out.width = '90%'}
validation_results <- tibble(
  vri_data_list,
  validation = map2(
    vri_data_list,
    vri_name_list,
    ~ generate_validation(
      data = .x,
      type = .y,
      n_days = forecast_horizon,
      start_date = min(.x$date, na.rm = T),
      validate_window_size = params$validate_window_size,
      window_size = 7,
      smooth_data = smooth,
      smoothing_cutoff = 10
    )
  )
)
names(validation_results$validation) <- vri_name_list
names(validation_results$vri_data_list) <- vri_name_list

for (vri in vri_name_list) {
  cat("\n\n\n")
  cat(glue::glue("#### {vri}"))
  cat("\n\n\n")
  print(plot_validation(data = vri_data_list[[vri]], validation_results$validation[[vri]], pred_plot = "ribbon"))
}
```

# Forecast Validation Metrics

### Description {.tabset}

This section summarizes the predictive performance of the forecasting model using quantitative metrics:

- SMAPE (Symmetric Mean Absolute Percentage Error): Measures forecast accuracy while handling zero values in observed data. Lower values indicate better predictions.

- MASE (Mean Absolute Scaled Error): Scales forecast errors relative to the average absolute change in historical observations. Values closer to 1 indicate performance similar to a naïve forecast; values <1 indicate better predictive performance.

For each virus, the metrics table reports:

- The training period used for model fitting
- The forecast period being evaluated
- SMAPE and MASE values

Higher SMAPE or MASE values suggest poorer historical forecast performance, which may indicate potential limitations in current short-term forecasts.

```{r forecast validation metrics, results = "asis"}
for (vri in vri_name_list) {
  cat(glue::glue("#### {vri}"))
  cat("\n\n\n")
  table_html <- generate_validation_metric(
    data = vri_data_list[[vri]],
    validation_res = validation_results$validation[[vri]]
    ) %>%
  as.data.frame() %>%
  knitr::kable(escape = FALSE, booktabs = TRUE) %>%
  kableExtra::kable_styling(full_width = FALSE) %>%
  as.character()
  
  cat(table_html, "\n\n")
}
```


