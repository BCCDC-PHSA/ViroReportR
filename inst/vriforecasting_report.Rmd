---
title: "Summary report of short-term forecasts for viral respiratory diseases by `ViroReportR`"
output: html_document
editor_options: 
  chunk_output_type: console
params:
  filepath:
    value: x
---


```{r setup, include=FALSE, echo = FALSE,  message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
# setup -------------------------------------------------------------------
library(dplyr)
library(ViroReportR)
library(ggplot2)
library(here)
library(DT)
library(purrr)


# Read in config file
config <- yaml::yaml.load_file(here::here("inst/config.yml"))
```


```{r load data}
# Data setup and cleaning code
vri_data <- read.csv(file.path(params$filepath))
# VRI names dictionary
disease_dict <- vri_data$disease_types

# Drop disease types column
vri_data <- vri_data %>%
  select(-disease_types)
```

```{r load RDS for demo run}
load("~/Desktop/bccdc/smoothed_forecasts.RData")
```

```{r generate forecasts, eval = FALSE}
forecasts <- tibble(
  plover_list = vri_data,
  forecasts = map2(
    plover_list,
    disease_dict,
    ~ forecast_time_period(.x,
      type = .y,
      n_days = 14,
      start_date = cred$common_plover_date
    )
  )
)
```


```{r assign pretty dict names}
# Fix names
names(plover_forecasts$forecasts) <- disease_dict
names(phrdw_forecasts$forecasts) <- disease_dict

names(plover_forecasts$plover_list) <- disease_dict
names(phrdw_forecasts$phrdw_list) <- disease_dict
```


# Current season forecast {.tabset}

### Description 

This section presents the 1-week ahead model forecast for the current season for both PHRDW and PLOVER data. The 1-week ahead forecasted confirmed cases is reported with the 95% and 50% prediction interval. The last estimated reproduction number is also reported with the 95% confidence interval. 

```{r PLOVER forecast plots and info, results = "asis", out.width = '80%'}
for (vri in disease_dict) {
  cat(glue::glue("### {vri} {{.tabset}}"))
  cat("\n\n\n")
 print(plot(plover_forecasts$forecasts[[vri]]))
  cat("\n\n\n")
 print(ViroReportR:::plot_rt(phrdw_forecasts$forecasts[[vri]]))
  cat("\n\n\n")
  ViroReportR:::current_forecast_text(plover_forecasts$forecasts[[vri]])
  cat("\n\n\n")
}
```


# 1-week ahead Model Forecast Validation {.tabset}

### Description 

 The forecasting model is trained by fitting to historical data, which is used to then make the prediction 1-week ahead. Here, the fit of the model to the known historical data can be visualized. Overlap between the prediction interval and the historical cases indicates the performance of the model to forecast new cases over a 1 week time horizon

```{r PLOVER forecast validation plots, results = "asis", out.width = '90%'}
for (vri in disease_dict) {
  cat("\n\n\n")
  cat(glue::glue("### {vri} {{.tabset}}"))
  cat("\n\n\n")
  print(plot_validation(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]], pred_horizon_str = "1 week ahead", pred_plot = "violin"))
}
```

# Forecast validation metrics {.tabset}

### Description 

 The forecasting model is trained by fitting to historical data, which is used to then make the prediction 1-week ahead. Here, the fit of the model to the known historical data is summarized. For each of the weekly historical forecasts, the metrics output whether the forecasted confirmed cases lie in the 50 or 95% percentile interval as well as the mean-squared percentage error. A higher mean squared percentage error and a relatively larger proportion of forecasts outside the 95% percentile interval are indicative of poor quality historical (and thus likely current) forecasts. 

```{r DT initialization, include=FALSE}
htmltools::tagList(datatable(ViroReportR:::summary_ind_quantiles_formatter(time_period_result = plover_forecasts$forecasts$`Influenza-A`, data = plover_forecasts$plover_list$`Influenza-A`)))
```

```{r PLOVER forecast validation metrics, results = "asis"}
for (vri in disease_dict) {
  cat("\n\n\n")
  cat(glue::glue("### {vri} {{.tabset}}"))
  cat("\n\n\n")
  print(htmltools::tagList(datatable(ViroReportR:::summary_ind_quantiles_formatter(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]]))))
  cat("\n\n\n")
  ViroReportR:::validation_summary_text(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]])
  cat("\n\n\n")
   ViroReportR:::validation_summary_text_season(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]], year = 2021)
  cat("\n\n\n")
    ViroReportR:::validation_summary_text_season(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]], year = 2022)
  cat("\n\n\n")
   ViroReportR:::validation_summary_text_season(time_period_result = plover_forecasts$forecasts[[vri]], data = plover_forecasts$plover_list[[vri]], year = 2023)
}
```


