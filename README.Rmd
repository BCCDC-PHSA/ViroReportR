---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# ViroReportR <img src="package_logo/hex_logo.png" align="right" height="139" alt="" />


<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![CRAN status](https://www.r-pkg.org/badges/version/ViroReportR)](https://CRAN.R-project.org/package=ViroReportR)
[![R-CMD-check](https://github.com/BCCDC-PHSA/ViroReportR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/BCCDC-PHSA/ViroReportR/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of `ViroReportR` is to provide a toolbox to conveniently generate short-term forecasts (with accompanied diagnostics) for viral respiratory diseases.

## Installation

`ViroReportR` depends on the latest version of the `EpiEstim` package (2.4). Thus, this version of the package must be installed from GitHub prior to installing the `ViroReportR` package using: 

``` r
# install.packages("devtools")
install.packages('EpiEstim', repos = c('https://mrc-ide.r-universe.dev', 'https://cloud.r-project.org'))
```


You can then install the development version of `ViroReportR` from [GitHub](https://github.com/) with:

``` r

devtools::install_github("BCCDC-PHSA/ViroReportR")
```

## Quick Start

`ViroReportR` can be used to generate short-term forecasts with accompanied diagnostics in a few lines of code. We go through an example here where the `EpiEstim` backend is used to generate forecasts of Influenza-A.

```{r example}
library(ViroReportR)
```

We will use the PLOVER weekly data for Influenza A, which is included with the `ViroReportR` package. We then use the `get_weekly_plover` and `get_weekly_plover_by_date_type` functions to transform the PLOVER data into a dataset with two columns: `date` and `confirm` in accordance to format accepted by the model fitting functions. 

```{r process data}
disease_type <- "flu_a"
test_data <- simulate_data()
weekly_df <- get_weekly_plover_by_date_type(
  plover_data = weekly_data,
  type = disease_type,
  start_date = "2022-10-01",
  end_date = "2022-12-01"
  )

head(weekly_df)

```

## Model fitting and forecasting over sliding windows 

The `forecast_time_period_epiestim` can be used to produce both daily and weekly forecasts using weekly sliding windows. For this example, we produce forecasts using `EpiEstim` as the backend algorithm choice. The other current choice for the forecasting algorithm is `EpiFilter` (WIP).

We can produce forecasts aggregated by week by setting `time_period = weekly`. For the functionality, `n_days` must be a multiple of 7. Thus, specifying `n_days = 14` when `time_period = weekly` produces 14/7 i.e. 2-week ahead forecasts. 

```{r forecasting, message = FALSE}
time_period_result_daily <- forecast_time_period(
  data = weekly_df, 
start_date = "2022-10-02", n_days = 7, type = "flu_a", 
time_period = "daily" , algorithm = "EpiEstim"
)
```

Finally, we can plot a validation plot using the `plot_validation` function. We can plot 2 week ahead forecasts for example by setting the `pred_horizon` argument. 

```{r plot_validation, dpi = 300, fig.align = "center", fig.height = 5, fig.width = 5, out.width= '80%'}
plot_validation(time_period_result_daily, pred_horizon_str = "2 week ahead", pred_plot = "ribbon")
```

The object of class `forecast_time_period` produced by the `forecast_time_period` function also has a customized `summary` function. This function checks to see if the weekly data inputted fall into the ranges of the prediction quantiles and issues a warning if this is not the case. This can be a useful check to assess the forecasts produced and the model fit along with the validation plot. It takes in the same arguments as the `plot_validation` function above:

```{r summary of fit}
summary(time_period_result_daily, pred_horizon_str = "7 days ahead")
```

Finally, the `ViroReportR` package can conveniently generate an automated report for the current season for all supported viral respiratory diseases (Influenza-A, Influenza-B, RSV and SARS-CoV2) using the `generate_forecast_report` function, which renders an HTML report.

```{r generate report, eval = FALSE}
generate_forecast_report(output_dir = "PATH OF DIRECTORY")
```



