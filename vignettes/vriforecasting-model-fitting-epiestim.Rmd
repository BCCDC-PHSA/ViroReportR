---
title: "Model fitting and producing short-term forecasts using weekly data with EpiEstim"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Model Fitting and producing short-term forecasts using weekly data with EpiEstim}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(vriforecasting)
```

## Overview 

This vignette provides a short demonstration of the model fitting functions in `vriforecasting` which extend the functionality and wrap the `estimate_R` function from the `EpiEstim` package to produce short-term forecasts. 

## Loading in data

For this short demonstration, we will use the PLOVER weekly data for Influenza A, which is provided with the `vriforecasting` package. *Note that it is recommended to use weekly aggregated data for optimal performance with `EpiEstim`*. We then can use the `get_weekly_plover_by_date_type` function to transform the PLOVER data into a dataset with two columns: `date` and `confirm` in accordance to format accepted by the model fitting functions. When working with PHRDW data with `EpiEstim`, it is recommended to be aggregated to weekly data as well using the `get_phrdw_by_type_date_age` function and setting the time period argument to `time_period = "daily"`

```{r }
disease_type <- "flu_a"
weekly_plover_date_type <- get_weekly_plover_by_date_type(
   plover_data,
  type = disease_type,
  start_date = "2022-10-01",
  end_date = "2022-12-01")

head(weekly_plover_date_type)
```

## Model fitting

The model to estimate the reproduction number using `EpiEstim` can be fit using the `fit_epiestim_model` function as follows: 

```{r}
mod_fit <- fit_epiestim_model(data = weekly_plover_date_type, type = "flu_a")

head(mod_fit)
```

The function supports forecasting for SARS-CoV2, RSV and Influenza A and B primarily but also provides functionality to forecast other respiratory diseases. The type of viral respiratory disease to be forecasted can be specified by the `type` argument, which takes in the inputs `rsv`, `sars_cov2`, `flu_a` and `flu_b` respectively. Any other respiratory disease can be specified by setting `type = other`. If `type = other` is set, a user-specified `mean_si` and `std_si` must be passed to the function as well. 


## Fitting and forecasting over sliding windows 

The primary function used to fit and produce the short-term forecasts is the `forecast_time_period` function which wraps the `fit_epiestim_model` function. We can specify that `EpiEstim` be used to fit the model using the argument `algorithm = "EpiEstim"`. This function can be used to produce both daily and weekly forecasts using weekly sliding windows. We first demonstrate how it can be used to produce daily forecasts for 14 days ahead. This is controlled by the `n_days` parameter.

The `start_date` argument should be used to specify from which date in the dataset the forecasting should begin from. The function automatically checks to see if the incidence count on the specified start date is high enough to reliably estimate the reproduction number. If this is not the case, the function throws a warning which suggests an alternate start date. 

The function provides progress updates as it is running about the current time period the model is being fit for. 

```{r message = FALSE}
time_period_result_daily <- forecast_time_period(data = 
weekly_plover_date_type, start_date = "2022-10-02", n_days = 14, type = "flu_a", time_period = "daily", 
algorithm = "EpiEstim")
```

The forecasts can then be plotted  using the `plot` function which uses the output of `forecast_time_period`. The function takes in an object of of class `forecast_time_period`

```{r forecast_plot, dpi = 300, out.width = "70%"}
plot(time_period_result_daily) 
```

We can also produce forecasts aggregated by week by setting `time_period = "weekly"`. For the functionality, `n_days` must be a multiple of 7. Thus, specifying `n_days = 14` when `time_period = "weekly` produces 14/7 i.e. 2-week ahead forecasts. 

```{r message = FALSE}
time_period_result_weekly <- forecast_time_period(data = weekly_plover_date_type, 
start_date = "2022-10-02", n_days = 14, type = "flu_a",  time_period = "weekly", algorithm = "EpiEstim")
```


One can the plot the latest forecast again:

```{r forecast_plot_weekly, dpi = 300, out.width= '80%'}
plot(time_period_result_weekly) 
```

Finally, we can plot a validation violin plot using the `plot_validation` function. As the `EpiEstim` model fit is compatible with weekly forecasted data. this plot does not support daily forecasts. We can plot 1 week ahead forecasts for example by setting the `pred_horizon` argument. The function can produce either a `violin` or `ribbon` plot, which can be controlled by the `pred_plot` argument: 

```{r validation_plot_ribbon, dpi = 300, fig.align = "center", fig.height = 5, fig.width = 5, out.width= '80%'}
plot_validation(time_period_result_weekly, pred_horizon_str = "2 week ahead", pred_plot = "ribbon")
```

```{r validation_plot_violin, dpi = 300, fig.align = "center", fig.height = 5, fig.width = 5, out.width= '80%'}
plot_validation(time_period_result_weekly, pred_horizon_str = "1 week ahead", pred_plot = "violin")
```

The object of class `forecast_time_period` produced by the `forecast_time_period` function also has a customized `summary` function. This function checks to see if the weekly data inputted fall into the ranges of the prediction quantiles and issues a warning if this is not the case. This can be a useful check to assess the forecasts produced and the model fit along with the validation plot. It takes in the same arguments as the `plot_validation` function above:

```{r}
summary(time_period_result_weekly, pred_horizon_str = "1 week ahead")
```

Finally, the `vriforecasting` package can conveniently generate an automated report for the current season for all supported viral respiratory diseases (Influenza-A, Influenza-B, RSV and SARS-CoV2) using the `generate_forecast_report` function, which renders an HTML report.

```{r eval = FALSE}
generate_forecast_report(output_dir = "PATH OF DIRECTORY")
```

