---
title: "Model fitting and producing short-term forecasts using weekly data with vriforecasting"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Model Fitting and producing short-term forecasts using weekly data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(vriforecasting)
```

## Overview 

This vignette provides a short demonstration of the model fitting functions in `vriforecasting` which extend the functionality and wrap the `estimate_R` function from the `EpiEstim` package to produce short-term forecasts. The `

## Loading in data

For this short demonstration, we will use the PLOVER weekly data for Influenza A, which is provided with the `vriforecasting` package. We then use the `get_weekly_plover` and `get_weekly_plover_by_date_type` functions to transform the PLOVER data into a dataset with two columns: `date` and `confirm` in accordance to format accepted by the model fitting functions. 

```{r }
weekly_plover_data <- get_weekly_plover(plover_data)

disease_type <- "flu_a"
weekly_plover_date_type <- get_weekly_plover_by_date_type(
  weekly_plover_data = weekly_plover_data,
  type = disease_type,
  start_date = "2022-10-01",
  end_date = "2022-12-01")
```

## Model fitting

The model to estimate the reproduction number using `EpiEstim` can be fit using the `fit_epiestim_model` function as follows: 

```{r}
mod_fit <- fit_epiestim_model(data = weekly_plover_date_type, type = "flu_a")

head(mod_fit)
```

The function supports forecasting for SARS-CoV2, RSV and Influenza A and B primarily but also provides functionality to forecast other respiratory diseases. This can be done by specifying `type = other`. If `type = other` is set, a user-specified `mean_si` and `std_si` must be passed to the function as well. 


## Fitting and forecasting over sliding windows 

The primary function used to fit and produce the short-term forecasts is the `forecast_time_period_epiestim` function which wraps the `fit_epiestim_model` function. This function can be used to produce both daily and weekly forecasts using weekly sliding windows. We first demonstrate how it can be used to produce daily forecasts for 14 days ahead. This is controlled by the `ndays = 14` parameter. The function provides progress updates as it is running about the current time period the model is being fit for. 

```{r message = FALSE}
time_period_result_daily <- forecast_time_period_epiestim(data = 
weekly_plover_date_type, start_date_str = "2022-10-02", n_days = 15, type = "flu_a")
```

The forecasts can then be plotted at all the sliding windows used using the `plot` function which uses the output of `forecast_time_period_epiestim`

```{r, dpi = 300}
plot(time_period_result_daily)
```

We can also produce forecasts aggregated by week by setting `aggregate_week = TRUE`. For the functionality, `n_days` must be a multiple of 7. Thus, specifying `n_days = 14` when `aggregate_week = TRUE` produces 14/7 i.e. 2-week ahead forecasts. 

```{r }
time_period_result_weekly <- forecast_time_period_epiestim(data = weekly_plover_date_type, 
start_date_str = "2022-10-02", n_days = 14, type = "flu_a",  aggregate_week = TRUE)
```

These forecasts can then be plotted using the `plot_all_time_period_forecast_data` function which uses the output of `forecast_time_period_epiestim`

```{r, dpi = 300}
plot(time_period_result_weekly)
```

Additionally we can extract the forecasts into a dataframe using the `create_forecast_df` argument to pass on to the model validation plotting functions. This extracts the quantiles aggregated by the weeks along with with the value for each of the simulations. 

```{r}
head(create_forecast_df(time_period_result_weekly))
```

